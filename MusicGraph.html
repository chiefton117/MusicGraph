<!DOCTYPE html>
<meta charset="utf-8">
<style>

.links line {
  stroke: #999;
  stroke-opacity: 0.6;
}

.nodes circle {
  stroke: #fff;
  stroke-width: 1.5px;
}

text {
  font-family: sans-serif;
  font-size: 10px;
}
.container {
  display: block;
  margin: auto;
}

</style>
<head style="text-align: center; font-family: Arial;">
<!--<h1 style="text-align: center; font-family: Arial;">Last.fm Artist Graph</h1>-->
<div style="display: block;">
  <form id='userForm'>
  <input class="userInput" id="userTxt" type="text" value="chiefton117"></input>
  <input class="userInput" id="userNum" type="number" name="quantity"
   min="0" max="200" step="10" value="10"></input>
  <input type="button" id="genbtn" value="Generate">
</div>
</form>
<hr>
</head>
<body>

<output id="list"></output>
<div class="container" width="100%" height="100%">
  <svg style="display: block; margin: auto;" id="chart" width="1200" height="800"></svg>
</div>
</body>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
const numTags = 5; // Number of associated tags stored with an artist
window.firstClick = true;

$(document).ready(function() {
$('#genbtn').click(function() {

      if(!window.firstClick) {
          update();
      }
      if(window.firstClick) {
          window.firstClick = false;
      }

      var userTxt = $('#userTxt').val();
      var userNum = $('#userNum').val();
      window.numArtists;
      window.artists = new Array();
      var current;

      $.when(ajax1(userTxt, userNum)).done(function(data1){
        window.numArtists = data1.artists.artist.length;
        for(var i = 0; i < window.numArtists; i++) { // Initialize each artist with name and empty array
          current = data1.artists.artist[i].name;
            $.when(ajax2(current)).done(function(data2) {
            if(data2.toptags) {
              var arr = new Array();
                  for(var j = 0; j < numTags; j++) {
                    arr[j] = data2.toptags.tag[j];
                  }
              window.artists[i] = {
                name: current,
                tags: arr
              }
            }
            });
        }
      });


      for(var i = 0; i < window.numArtists; i++) { // Iterate through every artist and their tag to get tag NAMES
        for(var j = 0; j < numTags; j++) { // Literally iterate through every tag :((((
          if(window.artists[i] && window.artists[i].tags[j]) { // If the artist and each tag exist
          window.artists[i].tags[j] = window.artists[i].tags[j].name;
        }
      }
      }
      window.artistData = {
        nodes: [],
        links: []
      };

      for(var i in window.artists) { // Create JSON object for each node
        var item = window.artists[i];
        window.artistData.nodes.push({
          "id" : item.name,
          "group" : 1
        });
      }
      for(var i in window.artists) { // Literally check everything against everything
        var artist1 = window.artists[i];
        for(var j = i+1; j < numArtists; j++) {
          var artist2 = window.artists[j];
        var commonTags = getCommonTags(artist1, artist2);
          if(commonTags > 0) {
            window.artistData.links.push({
              "source" : artist1.name,
              "target" : artist2.name,
              "value" : commonTags
            });
          }
        }
      }


      console.log(window.artistData);
        

      var svg = d3.select("svg"),
      width = +svg.attr("width"),
      height = +svg.attr("height");

      var color = d3.scaleOrdinal(d3.schemeCategory20);

      var simulation = d3.forceSimulation()
          .force("link", d3.forceLink().id(function(d) { return d.id; }).strength(function(d) {return (d.value / 100)})) // Strength is common tags / 100
          .force("charge", d3.forceManyBody())
          .force("center", d3.forceCenter(width / 2, height / 2));

        var link = svg.append("g")
            .attr("class", "links")
          .selectAll("line")
          .data(window.artistData.links)
          .enter().append("line")
            .attr("stroke-width", function(d) { return Math.sqrt(d.value); });

        var node = svg.append("g")
            .attr("class", "nodes")
          .selectAll("g")
          .data(window.artistData.nodes)
          .enter().append("g")
          
        var circles = node.append("circle")
            .attr("r", 5)
            .attr("fill", function(d) { return color(d.group); })
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        var lables = node.append("text")
            .text(function(d) {
              return d.id;
            })
            .attr('x', 6)
            .attr('y', 3);

        node.append("title")
            .text(function(d) { return d.id; });

        simulation
            .nodes(window.artistData.nodes)
            .on("tick", ticked);

        simulation.force("link")
            .links(window.artistData.links);

        var radius = 15;
        node.attr("r", radius)

        function ticked() {
          link
              .attr("x1", function(d) { return d.source.x; })
              .attr("y1", function(d) { return d.source.y; })
              .attr("x2", function(d) { return d.target.x; })
              .attr("y2", function(d) { return d.target.y; });

          node
            .attr("transform", function(d) { return "translate(" + (d.x = Math.max(radius, Math.min(width - radius, d.x))) + "," + (d.y = Math.max(radius, Math.min(height - radius, d.y))) + ")";
             })
        }


});
});

  function update() {

  force.nodes(nodes).links(links);

  var l = svg.selectAll(".links ")
    .data(window.artistData.links, function(d) {return d.source + "," + d.target});
  var n = svg.selectAll(".node")
    .data(window.artistData.nodes, function(d) {return d.key});
  enterLinks(l);
  exitLinks(l);
  enterNodes(n);
  exitNodes(n);
  link = svg.selectAll(".link");
  node = svg.selectAll(".node");

  link.style("stroke-width", function(d) { return d.weight; });

  node.select("circle").attr("r", function(d) {return d.weight});

  force.start();
  }
  function dragstarted(d) {
    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }

  function dragended(d) {
    if (!d3.event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }


/*
  Returns the NUMBER of common tags between any two given artists
*/
function getCommonTags(artist1, artist2) {
  if(artist1 && artist2) {
    return artist1.tags.filter(value => artist2.tags.includes(value)).length;
  }
}
/*
  Returns the JSON call for artists for a given user
*/
function ajax1(username, limit) {
  return $.ajax({
        dataType: 'json',
        async: false,
        url: 'http://ws.audioscrobbler.com/2.0/?method=library.getartists&api_key=943bdddf5707846447a81b95edae1537&user=' + username + '&limit=' + limit + '&format=json'
      });
}
/*
  Returns the JSON call for tags for a given artist
*/
function ajax2(name) {
  return $.ajax({
        dataType: 'json',
        async: false,
        url: "http://ws.audioscrobbler.com/2.0/?method=artist.gettoptags&artist=" + name + "&api_key=943bdddf5707846447a81b95edae1537&format=json"
      });
}



</script>